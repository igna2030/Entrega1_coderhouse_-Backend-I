<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carrito de Compras</title>

    <link rel="stylesheet" href="/CSS/Style.CSS">
</head>

<body>
    <div style="text-align: left; margin-bottom: 20px;">
        <a href="/home">Volver al menú Principal</a>
    </div>

    <h1>Contenido del Carrito</h1>
    <hr />
    <div style="text-align: center; margin-bottom: 20px;">
        <p>
            ID del Carrito:
            <span id="cartIdSpan">{{cart._id}}</span>
        </p>
        {{#if cart.products}}
        <button id="clear-cart-btn" class="clear-cart-btn">
            Vaciar Carrito Completo
        </button>
        {{/if}}
    </div>

    {{#if cart.products}}
    <div class="products-list">
        {{#each cart.products}}
        <div class="product-item">
            <div>
                <h3>
                    {{productId.title}}
                </h3>
                <p>ID: {{productId._id}}</p>
                <p>Precio Unitario: ${{productId.price}}</p>
            </div>
            <div class="item-actions">
                <div>
                    <span>Cantidad:</span>
                    <strong>{{quantity}}</strong>
                </div>

                <button class="btn-link-style remove-one-btn" data-product-id="{{productId._id}}"
                    data-product-title="{{productId.title}}">
                    Eliminar Producto
                </button>
            </div>
        </div>
        {{/each}}
    </div>


    {{else}}
    <div>
        <p>Carrito Vacío</p>
        <p>Aún no hay productos en este carrito.</p>
    </div>
    {{/if}}

    <script>

        
        document.addEventListener('DOMContentLoaded', () => {
            
            const showMessage = (message, type = 'info') => {
                const toast = document.createElement('div');
                toast.textContent = message;

                toast.style.position = 'fixed';
                toast.style.top = '20px';
                toast.style.right = '20px';
                toast.style.padding = '8px 10px';
                toast.style.borderRadius = '4px';
                toast.style.color = '#fff';
                toast.style.fontSize = '14px';
                toast.style.zIndex = '9999';

                if (type === 'success') {
                    toast.style.background = '#28a745';
                } else if (type === 'error') {
                    toast.style.background = '#dc3545';
                } else {
                    toast.style.background = '#007bff';
                }

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.transition = 'opacity 0.3s ease';
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        if (toast.parentNode) toast.parentNode.removeChild(toast);
                    }, 300);
                }, 3000);
            };

            const cartIdSpan = document.getElementById('cartIdSpan');
            if (!cartIdSpan) return;
            const clearCartBtn = document.getElementById('clear-cart-btn');
            const cartId = cartIdSpan.textContent.trim();

            const removeBtns = document.querySelectorAll('.remove-one-btn');

            removeBtns.forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const productId = e.target.getAttribute('data-product-id');
                    const productTitle = e.target.getAttribute('data-product-title');

                    if (!confirm(`¿Estás seguro de que quieres eliminar '${productTitle}' del carrito?`)) {
                        return;
                    }

                    const url = `/api/carts/${cartId}/products/${productId}`;
                    console.log('Intentando DELETE a URL:', url);

                    try {
                        const response = await fetch(url, { method: 'DELETE' });
                        const data = await response.json();

                        if (response.ok && data.status === 'success') {
                            alert(`Producto '${productTitle}' eliminado exitosamente.`);

                            window.location.reload();
                        } else {
                            alert(`Error al eliminar producto: ${data.message || 'Error desconocido.'}`);
                        }
                    } catch (error) {
                        console.error('Error de red al eliminar producto:', error);
                        alert('Error de conexión con el servidor.');
                    }
                });
            });
             if (clearCartBtn) { 
                clearCartBtn.addEventListener('click', async () => {
                    const url = `/api/carts/${cartId}`;

                    clearCartBtn.disabled = true;
                    clearCartBtn.textContent = 'Vaciando...';
                    showMessage('Vaciando el carrito completo...', 'info');

                    try {
                        const response = await fetch(url, { method: 'DELETE' });
                        const data = await response.json();

                        if (response.ok && data.status === 'success') {
                            showMessage('¡Carrito vaciado exitosamente! Redirigiendo...', 'success');
                            setTimeout(() => { window.location.reload(); }, 1000);
                        } else {
                            showMessage(`Error al vaciar el carrito: ${data.message || 'Error desconocido.'}`, 'error');
                            clearCartBtn.disabled = false;
                            clearCartBtn.textContent = 'Vaciar Carrito Completo';
                        }
                    } catch (error) {
                        console.error('Error de red al vaciar el carrito:', error);
                        showMessage('Error de conexión con el servidor.', 'error');
                        clearCartBtn.disabled = false;
                        clearCartBtn.textContent = 'Vaciar Carrito Completo';
                    }
                });
            }
        });
    </script>
</body>

</html>